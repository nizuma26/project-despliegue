{% extends 'componentes/form.html' %}
{% load static %}
{% load widget_tweaks %}

{% block head_form %}
<link rel="stylesheet" href="{% static 'lib/jquery-ui/jquery-ui.min.css' %}">
<link rel="stylesheet" href="{% static 'product/css/form.css' %}">
<link rel="stylesheet" href="{% static 'css/modal_style.css' %}">
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" id="formproduc" name="formproduc" style="font-size: 11px;">
    <div class="row">
        <div class="col-lg-9">
            <div class="card main_border_top">
                <div class="card-body">
                    {% csrf_token %}
                    <input name="actionprod" type="hidden" value="{{ action }}">
                    <input name="id" id="id" type="hidden" value="0">
                    <div class="row">
                        <div class="col-md-12" style="margin-top: -5px;">
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group input-group-sm">
                                        <label for="codigo" class="text-muted"
                                            style="margin-bottom: 0px;">CODIGO</label>
                                        {{form.codigo|attr:"autocomplete:off"}}
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <div class="form-group input-group-sm">
                                        <label for="unida_medida" class="text-muted" style="margin-bottom: 0px">UNIDAS
                                            DE MEDIDA</label>
                                        {{ form.unida_medida }}
                                    </div>
                                </div>
                            </div>
                            <div class="form-group input-group-sm">
                                <label for="nombre" class="control-label text-muted" style="margin-bottom: 0px;">NOMBRE
                                    PRODUCTO</label>
                                {{form.nombre}}
                            </div>
                            <div class="form-group input-group-sm">
                                <label for="descrip" class="control-label text-muted"
                                    style="margin-bottom: 0px;">DESCRIPCIÓN</label>
                                {{form.descripcion}}
                            </div>
                            <div class="row">
                                <div class="col-md-6 mt-1">
                                    <div class="input-group input-group-sm">
                                        <label for="categoria" class="text-muted"
                                            style="margin-bottom: 0px;">CATEGORIA</label>
                                        <div class="input-group">
                                            {{ form.categorias }}
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary btnAddCategoria input-flat py-0"
                                                    style="height: 29px;" type="button"><i class="fas fa-plus-circle"
                                                        style="font-size: 12px;"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6  mt-1">
                                    <div class="input-group input-group-sm">
                                        <label for="moneda" class="control-label text-muted"
                                            style="margin-bottom: 0px;">TIPO DE MONEDA</label>
                                        <div class="input-group">
                                            {{form.moneda}}
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary input-flat btnAddModelo py-0"
                                                    style="height: 29px;" type="button"><i class="fas fa-plus-circle"
                                                        style="font-size: 12px;"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mt-3">
                                    <div class="input-group input-group-sm">
                                        <label for="grupobien" class="control-label text-muted"
                                            style="margin-bottom: 0px;">GRUPO PRODUCTO</label>
                                        <div class="input-group">
                                            {{ form.grupobien }}
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary btnAddGroup input-flat py-0"
                                                    style="height: 29px;" type="button"><i class="fas fa-plus-circle f-12"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mt-3">
                                    <div class="input-group input-group-sm">
                                        <label for="subgrupobien" class="control-label text-muted"
                                            style="margin-bottom: 0px;">SUB GRUPO</label>
                                        <div class="input-group">
                                            {{ form.subgrupobien }}
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary btnAddSubgroup input-flat py-0"
                                                    style="height: 29px;" type="button"><i class="fas fa-plus-circle"
                                                        style="font-size: 12px;"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mt-3">
                                    <div class="input-group input-group-sm">
                                        <label for="marca" class="text-muted" style="margin-bottom: 0px;">MARCA
                                            PRODUCTO</label>
                                        <div class="input-group">
                                            {{ form.marca }}
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary btnAddMarca input-flat py-0"
                                                    style="height: 30px;" type="button"><i class="fas fa-plus-circle"
                                                        style="font-size: 12px;"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mt-3">
                                    <div class="input-group input-group-sm">
                                        <label for="modelo" class="text-muted" style="margin-bottom: 0px;">MODELO
                                            PRODUCTO</label>
                                        <div class="input-group">
                                            {{ form.modelo }}
                                            <div class="input-group-append">
                                                <button class="btn btn-sm btn-primary input-flat btnAddModelo py-0"
                                                    style="height: 30px;" type="button"><i class="fas fa-plus-circle"
                                                        style="font-size: 12px;"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3 mt-2">
                                <div class="col-md-7">
                                    <div class="form-group input-group-sm" style="margin-top: -3px;">
                                        <label for="comp" class="control-label text-muted"
                                            style="margin-bottom: 0px;">COMPONENTES</label>
                                        {{form.componentes}}
                                    </div>
                                </div>
                                <div class="col-md-5  mt-2">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group m-0 py-0 ml-2">
                                                <div class="custom-control custom-checkbox">
                                                    {{ form.activo }}
                                                    <label for="idactivo" class="custom-control-label"
                                                        style="padding-top: 5px;">ACTIVO</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group m-0 py-0 ml-2">
                                                <div class="custom-control custom-checkbox">
                                                    {{ form.inventariable }}
                                                    <label for="idinv" class="custom-control-label"
                                                        style="padding-top: 5px;">INVENTARIABLE</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group m-0 py-0 ml-2">
                                                <div class="custom-control custom-checkbox">
                                                    {{ form.pagaimpuesto }}
                                                    <label for="idpagaimpuesto" class="custom-control-label"
                                                        style="padding-top: 5px;">PAGA IMPUESTO</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group m-0 py-0 ml-2">
                                                <div class="custom-control custom-checkbox">
                                                    {{ form.lote }}
                                                    <label for="idlote" class="custom-control-label"
                                                        style="padding-top: 5px;">SOLÍCITA Nº LOTE</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group m-0 py-0 ml-2">
                                        <div class="custom-control custom-checkbox">
                                            {{ form.serie }}
                                            <label for="idserie" class="custom-control-label"
                                                style="padding-top: 5px;">SOLÍCITA Nº SERIE</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="row">
                                <div class="col-md-12 col-sm-4 col-xs-4" style="margin-top: -5px;">
                                    <div class="row" style="margin-top: 12px;">                    
                                        <div class="col-lg-12" style="padding-left: 10px;">
                                            <fieldset class="config p-0 m-0 mt-1">
                                                 <legend class="blue-grey"> CONFIGURACIÓN</legend>
                                                 <div class="form-group m-0 py-0 ml-2">
                                                    <div class="custom-control custom-checkbox">
                                                        {{ form.activo }}
                                                      <label for="idactivo" class="custom-control-label" style="padding-top: 5px;">ACTIVO</label>
                                                    </div>
                                                </div> 
                                                 <div class="form-group m-0 py-0 ml-2">
                                                    <div class="custom-control custom-checkbox">
                                                        {{ form.inventariable }}
                                                      <label for="idinv" class="custom-control-label" style="padding-top: 5px;">INVENTARIABLE</label>
                                                    </div>
                                                </div> 
                                                 <div class="form-group m-0 pt-0 ml-2">
                                                    <div class="custom-control custom-checkbox">
                                                        {{ form.pagaimpuesto }}
                                                      <label for="idpagaimpuesto" class="custom-control-label" style="padding-top: 5px;">PAGA IMPUESTO</label>
                                                    </div>
                                                </div>
                                                <div class="form-group m-0 py-0 ml-2">
                                                    <div class="custom-control custom-checkbox">
                                                        {{ form.lote }}
                                                      <label for="idlote" class="custom-control-label" style="padding-top: 5px;">SOLÍCITA Nº LOTE</label>
                                                    </div>
                                                </div>
                                                <div class="form-group m-0 py-0 ml-2">
                                                    <div class="custom-control custom-checkbox">
                                                        {{ form.serie }}
                                                      <label for="idserie" class="custom-control-label" style="padding-top: 5px;">SOLÍCITA Nº SERIE</label>
                                                    </div>
                                                </div> 
                                             </fieldset>
                                        </div>                                        
                                    </div>                     
                                </div>  
                            </div> -->

                        </div>
                        <!--fin columna 1 -->


                    </div>
                </div>
                <div class="card-footer py-2 text-center" style="margin-top: -10px;">
                    <button type="submit" class="btn btn-primary btn-sm btn-bord"><i class="fas fa-save"></i>
                        Guardar</button>
                    <a href="{{ list_url }}" class="btn btn-out btn-sm ml-2">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="card main_border_top">
                <div class="card-body">
                    <div class="container-fluid">
                        <div class="container-fluid">
                            {% if object.imagen %}
                                <div style="font-size: 12px;" class="mt-1 text-center">
                                    <img src="{{object.imagen.url}}" class="img-fluid shadow-sm" alt="Imagen"
                                        name="imagenPrevisualizacion" id="imagenPrevisualizacion"
                                        style="margin-top: 0px; margin-bottom: 2px;" height="180px" width="180px">
                                </div>
                            {% else %}
                                <div style="font-size: 12px;" class="mt-1 text-center">
                                    <img src="/media/producto/sin_imagen_2.png" class="img-fluid shadow-sm" alt="Imagen"
                                        name="imagenPrevisualizacion" id="imagenPrevisualizacion"
                                        style="margin-top: 0px; margin-bottom: 2px;" height="200px" width="200px">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col">
                            <button type="button" class="contenedor-btn-file btn btn-block text-sm bordeado">
                                <i class="far fa-file-image"></i>
                                Seleccionar Imagen
                                <label for="seleccionArchivos"></label>
                                {{form.imagen}}
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<div>
    <div id="mostrarmodalAddCateg">
        {% include 'category/modal_addcateg.html' %}
    </div>
    <div id="mostrarmodalAddMarca">
        {% include 'marca/modal_addmarca.html' %}
    </div>
    <div id="mostrarmodalAddModelo">
        {% include 'modelo/modal_addmodelo.html' %}
    </div>
</div>
{% endblock %}
{% block javascript_form %}
<script src="{% static 'lib/jquery-ui/jquery-ui.min.js' %}"></script>
<script src="{% static 'product/js/form.js' %}" type="text/javascript"></script>
<script type="application/javascript">
    const $seleccionArchivos = document.querySelector("#seleccionArchivos"),

        $imagenPrevisualizacion = document.querySelector("#imagenPrevisualizacion");

    $seleccionArchivos.addEventListener("change", () => {
        const archivos = $seleccionArchivos.files;

        if (!archivos || !archivos.length) {
            $imagenPrevisualizacion.src = "";
            return;
        }
        const primerArchivo = archivos[0];
        const objectURL = URL.createObjectURL(primerArchivo);
        $imagenPrevisualizacion.src = objectURL;
    });
    // $("#idpagaimpuesto").change(function(){
    //     let check=$('#idpagaimpuesto').prop("checked")
    //     if (check == true){
    //         $("#idimpuesto").prop("disabled", false);
    //     }else{
    //         $("#idimpuesto").prop("disabled", true);
    //     }
    // });

    let select_subgrupos = $('select[name="subgrupobien"]');
    $(function () {
        $('.select2').select2({
            theme: "bootstrap4",
            language: 'es'
        });
        $('select[name="grupobien"]').on('change', function () {
            let id = $(this).val();
            //alert(id)
            let options = '<option value="">------------</option>';
            if (id === '') {
                select_subgrupos.html(options);
                return false;
            }
            $.ajax({
                url: window.location.pathname,
                type: 'POST',
                data: {
                    'action': 'search_subgrupos_id',
                    'id': id
                },
                dataType: 'json',
            }).done(function (data) {
                if (!data.hasOwnProperty('error')) {
                    select_subgrupos.html('').select2({
                        theme: "bootstrap4",
                        language: 'es',
                        data: data
                    });
                    /*$.each(data, function (key, value) {
                        options += '<option value="' + value.id + '">' + value.name + '</option>';
                    });*/
                    return false;
                }
                message_error(data.error);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert(textStatus + ': ' + errorThrown);
            }).always(function (data) {
                //select_products.html(options);
            });
        });        
    });
    //codigo para los select 2 anidados (Marcas y Modelos)
    let select_modelos = $('select[name="modelo"]');
    $(function () {
        //esta funcion me redenderiza la imagen que se cargue en el control img 
        $('.select2').select2({
            theme: "bootstrap4",
            language: 'es'
        });
        $('select[name="marca"]').on('change', function () {
            let id = $(this).val();
            // alert(id)
            let options = '<option value="">------------</option>';
            if (id === '') {
                select_modelos.html(options);
                return false;
            }
            $.ajax({
                url: window.location.pathname,
                type: 'POST',
                data: {
                    'action': 'search_modelos_id',
                    'id': id
                },
                dataType: 'json',
            }).done(function (data) {
                if (!data.hasOwnProperty('error')) {
                    select_modelos.html('').select2({
                        theme: "bootstrap4",
                        language: 'es',
                        data: data
                    });
                    /*$.each(data, function (key, value) {
                        options += '<option value="' + value.id + '">' + value.name + '</option>';
                    });*/
                    return false;
                }
                message_error(data.error);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert(textStatus + ': ' + errorThrown);
            }).always(function (data) {
                //select_products.html(options);
            });
        });
        select_modelos.on('change', function () {
            let value = select_modelos.select2('data')[0];
            // console.log(value);
        });
        const inputField = $('#idmarcas');
        inputField.on('keydown.autocomplete', function () {
            $(this).autocomplete({
                source: function (request, response) {
                    $.ajax({
                        url: window.location.pathname,
                        type: 'POST',
                        data: {
                            'action': 'marcas_autocomplete',
                            'term': request.term
                        },
                        dataType: 'json',
                    }).done(function (data) {
                        response(data);
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        //alert(textStatus + ': ' + errorThrown);
                    }).always(function (data) {
                    });
                },
                delay: 300,
                minLength: 1,

                select: function (event, ui) {
                    let marca_val = ui.item.id;
                    $('#marca_id').val(marca_val);
                }
            });
        });
    });        
</script>
{% endblock %}